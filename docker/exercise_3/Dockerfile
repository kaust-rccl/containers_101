### change this tag to the latest version of ubuntu
FROM ubuntu:latest

####### colapse the RUN commands into one to reduce the number of layers ########
# update the system
RUN apt-get update && apt-get install -y vim git wget && wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh

#############################################################################
# set a ARG to direct to the miniconda installation file
ARG CONDA_HOME=/software/miniconda3
RUN mkdir -p /software/conda_cache
ARG CONDA_PKGS_DIRS=/software/conda_cache

# install miniconda in user's miniconda3 directory
RUN bash Miniconda3-latest-Linux-x86_64.sh -b -p $CONDA_HOME

# define environment path
ENV PATH=$PATH:${CONDA_HOME}/condabin:${CONDA_HOME}/bin

# copy packages folder to container this is recomended for small files 
COPY packages packages

# update conda
RUN conda update --name base --channel defaults --yes conda && conda install --name base --channel conda-forge mamba --yes

########## install packages in base environment ##########
RUN mamba env update -f packages/environment.yml
# install packages from environment.yml that contains jupyter lab
RUN mamba env create -f packages/environment2.yml
# use ipykernel to create a kernel for the environment data-science
RUN python -m ipykernel install --name kernel_one --display-name "Data-science"

# remove packages folder and miniconda installation file
RUN rm -rf packages && rm Miniconda3-latest-Linux-x86_64.sh && mkdir /home/data

# using WORKDIR is preferred to using 'RUN cd /some/path'
WORKDIR /home/data

# create a file in the data directory
RUN echo "Hello from Volume" > test
# RUN touch /software/config/jupyter

# create a volume for the data directory 
# VOLUME is volumes are the preferred mechanism for persisting data generated by and used by Docker containers
VOLUME /home/data

# Settings for Jupyter

RUN mkdir -p /software/config/jupyter/migrated 
# make all directories created by jupyter have 755 permission using find
SHELL [ "find", "/software/config/jupyter", "-type", "d", "-exec", "chmod", "755", "{}" ]
# RUN find /software/config/jupyter -type d -exec chmod 755 {}

ENV JUPYTER_CONFIG_DIR=/software/config/jupyter
ENV JUPYTER_CONFIG_PATH=/software/config/jupyter
ENV JUPYTER_DATA_DIR=/workdir
ENV JUPYTER_RUNTIME_DIR=/workdir


################ Conda activation ################
# this is the conda activation script
# this will be executed on startup
################################################

SHELL ["/bin/bash","-c"]
RUN conda init bash
RUN echo "conda activate base" >> ~/.bashrc

################# ENTRYPOINT #################
# this is the entrypoint for the container and will be executed on startup
# this also will allow us to pass arguments to the container
################################################

# uncomment the following lines to use the entrypoint.sh script

COPY entrypoint.sh /software/entrypoint.sh
RUN chmod +x /software/entrypoint.sh
ENTRYPOINT ["/software/entrypoint.sh"]